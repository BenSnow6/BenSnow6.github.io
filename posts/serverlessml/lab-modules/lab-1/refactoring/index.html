<!doctype html><html><head><title>Refactoring the pipeline</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600"><link rel=stylesheet href=/fontawesome/css/all.min.css><meta property="og:title" content="Refactoring the pipeline"><meta property="og:description" content="Following along with the serverless-ml online course by Jim Dowling and Hopsworks."><meta property="og:type" content="article"><meta property="og:url" content="https://BenSnow6.github.io/posts/serverlessml/lab-modules/lab-1/refactoring/"><meta property="article:published_time" content="2022-10-05T00:00:00+00:00"><meta property="article:modified_time" content="2022-10-05T00:00:00+00:00"><meta name=description content="Following along with the serverless-ml online course by Jim Dowling and Hopsworks."><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>Ben Snow's Blog</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><a href=/posts/introduction/ title=Introduction>Introduction</a></li><li><a href=/posts/restructuring/ title=Restructuring>Restructuring</a></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/serverlessml/>Serverless ML</a><ul class=active><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/serverlessml/lab-modules/>Lab Modules</a><ul class=active><li><a href=/posts/serverlessml/lab-modules/lab-0/ title="Lab 0">Lab 0</a></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/serverlessml/lab-modules/lab-1/>Lab 1</a><ul class=active><li><a href=/posts/serverlessml/lab-modules/lab-1/end-to-end-pipeline/ title="End to End">End to End</a></li><li><a class=active href=/posts/serverlessml/lab-modules/lab-1/refactoring/ title=Refactoring>Refactoring</a></li></ul></li></ul></li><li><a href=/posts/serverlessml/lectures/ title=Lectures>Lectures</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://BenSnow6.github.io/posts/serverlessml/lab-modules/lab-1/refactoring/hero.png)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/avatar_hub7979d5c0b641038ae587dc7f4e229bf_336111_120x120_fit_q75_box.jpg alt="Author Image"><h5 class=author-name>Ben Snow</h5><p>:date_full</p></div><div class=title><h1>Refactoring the pipeline</h1></div><div class=post-content id=post-content><p>06/10/2022</p><h1 id=refactoring>Refactoring</h1><p>Our little web app in the previous article is nice but it&rsquo;s quite rigid in structure, very reliant on the notebook, doesn&rsquo;t allow for new data to be added, and can&rsquo;t work standalone. Let&rsquo;s take some steps to refactor this pipeline and deploy it in a better way.</p><p>The new architecture for the pipeline we wish to implement will look like this !</p><table><thead><tr><th style=text-align:center><img src=images/refactor.png alt=refactor></th></tr></thead><tbody><tr><td style=text-align:center>Fig 1. Refactored machine learning pipeline for the refactored section of the lab.</td></tr></tbody></table><p>There will be three pipelines, a feature pipeline, training pipeline, and inference pipeline. Our previous notebook will be used to create features which will then be saved in a hopsworks feature store using the practices we learnt in the last lab [[Module 0 labs]]. After this, we will use the feature store to train a model in a new notebook called iris-train-model and then will register this model to hopsworks. Then, when an inference is requested, we will serve the model with hopsworks, along with the required data, to an inference notebook: iris-batch-inference-pipeline.</p><p>Production systems rarely, if ever, have static datasets. They are constantly evolving with new data being introduced all the time. This will be taken into consideration in our model by creating a synthetic data generation function that will create new iris data samples every 24 hours that will be back filled to our feature store.</p><h2 id=feature-pipeline>Feature pipeline</h2><p>Before creating our pipeline, we install some dependencies, log in to hopsworks with our API key, and grab our feature store:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#960050;background-color:#1e0010>!</span>pip install <span style=color:#f92672>-</span>U hopsworks <span style=color:#f92672>--</span>quiet
<span style=color:#f92672>import</span> random
<span style=color:#f92672>import</span> pandas <span style=color:#f92672>as</span> pd
<span style=color:#f92672>import</span> hopsworks

project <span style=color:#f92672>=</span> hopsworks<span style=color:#f92672>.</span>login() <span style=color:#75715e>#log in with API key</span>
fs <span style=color:#f92672>=</span> project<span style=color:#f92672>.</span>get_feature_store() <span style=color:#75715e># collect feature store</span>
</code></pre></div><p>We will begin by populating a feature group called &lsquo;iris&rsquo; with the full iris dataset. This will all take place in the iris-feature-pipeline.ipynb. We have a toggle here called <code>BACKFILL</code> that we can set to either populate the feature group with the original iris dataset or to add new synthetic data to the feature group.</p><p>We start with <code>BACKFILL = True</code> and create a feature group and insert the df with:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>iris_fg <span style=color:#f92672>=</span> fs<span style=color:#f92672>.</span>get_or_create_feature_group(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;iris&#34;</span>,
                                  version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,
                                  primary_key<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;sepal_length&#34;</span>,<span style=color:#e6db74>&#34;sepal_width&#34;</span>,<span style=color:#e6db74>&#34;petal_length&#34;</span>,<span style=color:#e6db74>&#34;petal_width&#34;</span>],
                                  description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Iris flower dataset&#34;</span>
                                 )
iris_fg<span style=color:#f92672>.</span>insert(iris_df)
</code></pre></div><p>Previous to this, we used pandas to read in the dataset to a df:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>iris_df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>&#34;https://repo.hops.works/master/hopsworks-tutorials/data/iris.csv&#34;</span>)
</code></pre></div><p>We have also written a few short functions to generate the characteristics of a single random flower and return this as a dataframe. This will come in useful when we wish to add more data to our feature group.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generate_flower</span>(name, sepal_len_max, sepal_len_min, sepal_width_max, sepal_width_min,petal_len_max, petal_len_min, petal_width_max, petal_width_min):

    <span style=color:#e6db74>&#34;&#34;&#34;Creates a DataFrame containing the characteristics of a single iris flower given its name
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>	Args:
</span><span style=color:#e6db74>        name (string): Name of the flower requested
</span><span style=color:#e6db74>        sepal_len_max (float): Max length of the sepal
</span><span style=color:#e6db74>        sepal_len_min (float): Min length of the sepal
</span><span style=color:#e6db74>        sepal_width_max (float): Max width of the sepal
</span><span style=color:#e6db74>        sepal_width_min (float): Min width of the sepal
</span><span style=color:#e6db74>        petal_len_max (float): Max length of the petal
</span><span style=color:#e6db74>        petal_len_min (float): Min length of the petal
</span><span style=color:#e6db74>        petal_width_max (float): Max width of the petal
</span><span style=color:#e6db74>        petal_width_min (float): Min width of the petal
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    Returns:
</span><span style=color:#e6db74>        df (pd.DataFrame): DataFrame containing one iris flower
</span><span style=color:#e6db74>    &#34;&#34;&#34;</span>

    df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame({ <span style=color:#e6db74>&#34;sepal_length&#34;</span>: [random<span style=color:#f92672>.</span>uniform(sepal_len_max, sepal_len_min)],
                       <span style=color:#e6db74>&#34;sepal_width&#34;</span>: [random<span style=color:#f92672>.</span>uniform(sepal_width_max, sepal_width_min)],
                       <span style=color:#e6db74>&#34;petal_length&#34;</span>: [random<span style=color:#f92672>.</span>uniform(petal_len_max, petal_len_min)],
                       <span style=color:#e6db74>&#34;petal_width&#34;</span>: [random<span style=color:#f92672>.</span>uniform(petal_width_max, petal_width_min)]
                      })
    df[<span style=color:#e6db74>&#39;variety&#39;</span>] <span style=color:#f92672>=</span> name
    <span style=color:#66d9ef>return</span> df

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_random_iris_flower</span>():
    <span style=color:#e6db74>&#34;&#34;&#34;Returns a DataFrame containing one random iris flower
</span><span style=color:#e6db74>  
</span><span style=color:#e6db74>    Returns:
</span><span style=color:#e6db74>        iris_df (pd.DataFrame): DataFrame containing the random iris flower&#39;s characteristics
</span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
    virginica_df <span style=color:#f92672>=</span> generate_flower(<span style=color:#e6db74>&#34;Virginica&#34;</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>5.5</span>, <span style=color:#ae81ff>3.8</span>, <span style=color:#ae81ff>2.2</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>4.5</span>, <span style=color:#ae81ff>2.5</span>, <span style=color:#ae81ff>1.4</span>)
    versicolor_df <span style=color:#f92672>=</span> generate_flower(<span style=color:#e6db74>&#34;Versicolor&#34;</span>, <span style=color:#ae81ff>7.5</span>, <span style=color:#ae81ff>4.5</span>, <span style=color:#ae81ff>3.5</span>, <span style=color:#ae81ff>2.1</span>, <span style=color:#ae81ff>3.1</span>, <span style=color:#ae81ff>5.5</span>, <span style=color:#f92672>.</span><span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>1.0</span>)
    setosa_df <span style=color:#f92672>=</span>  generate_flower(<span style=color:#e6db74>&#34;Setosa&#34;</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>4.5</span>, <span style=color:#ae81ff>4.5</span>, <span style=color:#ae81ff>2.3</span>, <span style=color:#ae81ff>1.2</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0.7</span>, <span style=color:#ae81ff>0.3</span>)
    <span style=color:#75715e># randomly pick one of these 3 and write it to the featurestore</span>
    pick_random <span style=color:#f92672>=</span> random<span style=color:#f92672>.</span>uniform(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>3</span>)
    <span style=color:#66d9ef>if</span> pick_random <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>2</span>:
        iris_df <span style=color:#f92672>=</span> virginica_df
    <span style=color:#66d9ef>elif</span> pick_random <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>1</span>:
        iris_df <span style=color:#f92672>=</span> versicolor_df
    <span style=color:#66d9ef>else</span>:
        iris_df <span style=color:#f92672>=</span> setosa_df
    <span style=color:#66d9ef>return</span> iris_df
</code></pre></div><p>If we set <code>BACKFILL=False</code> we can call this <code>get_random_iris_flower()</code> function and then set that to be the <code>iris_df</code> which will then be inserted to the feature group.</p><p><a href=https://github.com/BenSnow6/serverless-ml-course/blob/main/src/01-module/iris-feature-pipeline.ipynb>Have a look at the notebook in my github repo here.</a></p><h2 id=training-pipeline>Training pipeline</h2><p>We need to start our training pipeline by logging in to the hopsworks platform and grabbing the feature store like in the feature pipeline above. On top of this, we import some basic libraries:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> sklearn.neighbors <span style=color:#f92672>import</span> KNeighborsClassifier
<span style=color:#f92672>from</span> sklearn.metrics <span style=color:#f92672>import</span> accuracy_score
<span style=color:#f92672>import</span> pandas <span style=color:#f92672>as</span> pd
<span style=color:#f92672>import</span> seaborn <span style=color:#f92672>as</span> sns
<span style=color:#f92672>import</span> hopsworks
</code></pre></div><p>These will be used to handle the data as well as creating and evaluating our model.</p><h3 id=feature-view>Feature view</h3><p>We will now grab the feature view if we have one, in this case we don&rsquo;t but we will in subsequent runs of the pipeline. Since we don&rsquo;t have a feature view, we will create one.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>try</span>:
    feature_view <span style=color:#f92672>=</span> fs<span style=color:#f92672>.</span>get_feature_view(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;iris&#34;</span>, version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) <span style=color:#75715e>## collect if exists</span>
<span style=color:#66d9ef>except</span>:
    iris_fg <span style=color:#f92672>=</span> fs<span style=color:#f92672>.</span>get_feature_group(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;iris&#34;</span>, version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) <span style=color:#75715e># create if not exists</span>
    query <span style=color:#f92672>=</span> iris_fg<span style=color:#f92672>.</span>select_all() <span style=color:#75715e># grab all features from feature group</span>
    feature_view <span style=color:#f92672>=</span> fs<span style=color:#f92672>.</span>create_feature_view(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;iris&#34;</span>, <span style=color:#75715e># name of feature view</span>
                                      version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, <span style=color:#75715e># version number</span>
                                      description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Read from Iris flower dataset&#34;</span>,
                                      labels<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;variety&#34;</span>], <span style=color:#75715e># variety is target label</span>
                                      query<span style=color:#f92672>=</span>query) <span style=color:#75715e># select all feaures with query</span>
</code></pre></div><p>This will then show up in the hopsworks website.</p><p>After this is complete, we use the feature view to create a train/test split to train our model:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>X_train, X_test, y_train, y_test <span style=color:#f92672>=</span> feature_view<span style=color:#f92672>.</span>train_test_split(<span style=color:#ae81ff>0.2</span>, ) <span style=color:#75715e>#80:20 tr/t</span>
</code></pre></div><p>and create an fit a KNN model to our training data:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>model <span style=color:#f92672>=</span> KNeighboursClassifier(n_neighbours<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>) <span style=color:#75715e># 2 nearest neighbour classifier</span>
model<span style=color:#f92672>.</span>fit(X_train, y_train<span style=color:#f92672>.</span>values<span style=color:#f92672>.</span>ravel()) <span style=color:#75715e># fit to training data</span>
</code></pre></div><p>After this we can create predictions on the test set, generate the classification report, and a heatmap of the confusion matrix, just like in the End to end pipeline.</p><table><thead><tr><th style=text-align:center><img src=images/conf_refactored.png alt="refactored conf"></th></tr></thead><tbody><tr><td style=text-align:center>Fig 2.Confusion matrix of trained KNN model.</td></tr></tbody></table><p>Here we can see that the model predicts with 100% accuracy, but this does not indicate that the model is perfect by any means! The model is only tested on a small number of samples and we don&rsquo;t know if they are reflective of all possible samples we could test with.</p><h3 id=registering-a-model-on-hopsworks>Registering a model on Hopsworks</h3><p>Now that we have trained a model and tested it, we will register it online with hopsworks. To do this, we need to import some dependencies:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> hsml.schema <span style=color:#f92672>import</span> Schema <span style=color:#75715e># creating data schema</span>
<span style=color:#f92672>from</span> hsml.model_schema <span style=color:#f92672>import</span> ModelSchema <span style=color:#75715e># creating model schema</span>
<span style=color:#f92672>import</span> os
<span style=color:#f92672>import</span> joblib <span style=color:#75715e># to save the model</span>
<span style=color:#f92672>import</span> hopsworks
<span style=color:#f92672>import</span> shutil <span style=color:#75715e># for copying files</span>
</code></pre></div><p>We start by grabbing the model registry, creating a directory to save everything, and saving the model as a pickle file along with the confusion matrix image:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>project <span style=color:#f92672>=</span>  hopsworks<span style=color:#f92672>.</span>login() <span style=color:#75715e># Connect to Hopsworks</span>
mr <span style=color:#f92672>=</span> project<span style=color:#f92672>.</span>get_model_registry() <span style=color:#75715e># Get the model registry</span>

<span style=color:#75715e># The &#39;iris_model&#39; directory will be saved to the model registry</span>
model_dir<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;iris_model&#34;</span> <span style=color:#75715e># The directory where the model will be saved</span>
<span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>isdir(model_dir) <span style=color:#f92672>==</span> False:
    os<span style=color:#f92672>.</span>mkdir(model_dir) <span style=color:#75715e># Create the directory if it does not exist</span>
joblib<span style=color:#f92672>.</span>dump(model, model_dir <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/iris_model.pkl&#34;</span>) <span style=color:#75715e># Save the model to the directory</span>
<span style=color:#75715e># Copy the confusion matrix to the directory</span>
shutil<span style=color:#f92672>.</span>copyfile(<span style=color:#e6db74>&#34;assets/confusion_matrix.png&#34;</span>, model_dir <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/confusion_matrix.png&#34;</span>) <span style=color:#e6db74>``</span><span style=color:#960050;background-color:#1e0010>`</span>

We then create a schema <span style=color:#66d9ef>for</span> the input <span style=color:#f92672>and</span> output data along <span style=color:#66d9ef>with</span> a model schema<span style=color:#f92672>.</span> Also included <span style=color:#f92672>is</span> a small sample of the training features <span style=color:#66d9ef>for</span> our benefit:
<span style=color:#e6db74>``</span><span style=color:#960050;background-color:#1e0010>`</span>python
input_example <span style=color:#f92672>=</span> X_train<span style=color:#f92672>.</span>sample() <span style=color:#75715e># Get a sample from the training data</span>
input_schema <span style=color:#f92672>=</span> Schema(X_train) <span style=color:#75715e># Create a schema from the feature training data</span>
output_schema <span style=color:#f92672>=</span> Schema(y_train) <span style=color:#75715e># Create a schema from the label training data</span>
model_schema <span style=color:#f92672>=</span> ModelSchema(input_schema, output_schema) <span style=color:#75715e># Create a model schema from the input and output schema</span>
</code></pre></div><p>Finally, we use the model registry to save the model to hopsworks:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>iris_model <span style=color:#f92672>=</span> mr<span style=color:#f92672>.</span>python<span style=color:#f92672>.</span>create_model( <span style=color:#75715e># Create a model in the model registry</span>
    version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, <span style=color:#75715e># The version of the model</span>
    name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;iris&#34;</span>,  <span style=color:#75715e># The name of the model</span>
    metrics<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;accuracy&#34;</span> : metrics[<span style=color:#e6db74>&#39;accuracy&#39;</span>]}, <span style=color:#75715e># The metrics of the model</span>
    model_schema<span style=color:#f92672>=</span>model_schema, <span style=color:#75715e># The model schema</span>
    input_example<span style=color:#f92672>=</span>input_example,  <span style=color:#75715e># The input example of the model</span>
    description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Iris Flower Predictor&#34;</span>) <span style=color:#75715e># The description of the model</span>

iris_model<span style=color:#f92672>.</span>save(model_dir) <span style=color:#75715e># Save the model to the model registry</span>
</code></pre></div><p><a href=https://c.app.hopsworks.ai:443/p/2289/models/iris/1>We can now view this in hopsworks!</a></p><h2 id=inference-pipeline>Inference pipeline</h2><p>We&rsquo;ve successfully refactored our feature and training pipelines and now we&rsquo;re going to refactor the inference pipeline. This pipeline will take the trained model from our model registry and will allow us to query it for a prediction. We also wish to create an interface to give the user some feedback on how well the model is performing and a visual representation of the predicted image vs the ground truth image.</p><p>To start, like each other pipeline, import some useful packages, log in to hopsworks, and grab the feature store.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> pandas <span style=color:#f92672>as</span> pd
<span style=color:#f92672>import</span> hopsworks
<span style=color:#f92672>import</span> joblib
  
project <span style=color:#f92672>=</span> hopsworks<span style=color:#f92672>.</span>login()
fs <span style=color:#f92672>=</span> project<span style=color:#f92672>.</span>get_feature_store()
</code></pre></div><p>To make an inference, we must get the model from our model registry. We can do this by grabbing the model registry, getting a reference to the model, downloading it, then loading it into memory:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>mr <span style=color:#f92672>=</span> project<span style=color:#f92672>.</span>get_model_registry() <span style=color:#75715e># Get the model registry</span>
model <span style=color:#f92672>=</span> mr<span style=color:#f92672>.</span>get_model(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;iris&#34;</span>, version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) <span style=color:#75715e># Get the model from the model registry</span>
model_dir <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>download() <span style=color:#75715e># Download the model to the local directory</span>
model <span style=color:#f92672>=</span> joblib<span style=color:#f92672>.</span>load(model_dir <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/iris_model.pkl&#34;</span>) <span style=color:#75715e># Load the model</span>
</code></pre></div><p>Next, we want to access our feature view and download a batch of data from it. If we just call <code>get_batch_data</code> on the feature view, we will be returned the entire dataset. Let&rsquo;s start with that:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>feature_view <span style=color:#f92672>=</span> fs<span style=color:#f92672>.</span>get_feature_view(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;iris&#34;</span>, version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) <span style=color:#75715e># Get the feature view</span>
batch_data <span style=color:#f92672>=</span> feature_view<span style=color:#f92672>.</span>get_batch_data() <span style=color:#75715e># Get the batch data from the feature view</span>
y_pred <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>predict(batch_data) <span style=color:#75715e># Predict on the batch data</span>
</code></pre></div><p>Here we have created predictions for the entire feature view. We&rsquo;re interested in the most recent prediction so will use <code>y_pred[y_pred.size-1]</code> to access it.</p><p>We want to show the user the predicted flower from the model so will use this last prediction to access the image from our local directory:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>flower <span style=color:#f92672>=</span> y_pred[y_pred<span style=color:#f92672>.</span>size<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#75715e># Get the last prediction</span>
flower_img <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;assets/&#34;</span> <span style=color:#f92672>+</span> flower <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.png&#34;</span> <span style=color:#75715e># Get the image path</span>
img <span style=color:#f92672>=</span> Image<span style=color:#f92672>.</span>open(flower_img) <span style=color:#75715e># Open the image</span>
img<span style=color:#f92672>.</span>save(<span style=color:#e6db74>&#34;../../assets/latest_iris.png&#34;</span>) <span style=color:#75715e># Save the image as the latest prediction</span>
</code></pre></div><p>In order to get the <strong>actual</strong> flower, we need to access the feature group and get the last row of data. We can do this by getting the feature group &lsquo;iris&rsquo; and reading it into a dataframe. Then, if we access the last row of the dataframe, we can get the label by querying the &ldquo;variety&rdquo; column:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>iris_fg <span style=color:#f92672>=</span> fs<span style=color:#f92672>.</span>get_feature_group(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;iris&#34;</span>, version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>) <span style=color:#75715e># Get the feature group</span>
df <span style=color:#f92672>=</span> iris_fg<span style=color:#f92672>.</span>read() <span style=color:#75715e># Read the feature group into a dataframe</span>
label <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>iloc[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>][<span style=color:#e6db74>&#34;variety&#34;</span>] <span style=color:#75715e># Get the label of the last row</span>
</code></pre></div><p>Now we can grab the image associated to the actual flower and save this to our directory too:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>label_flower <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;assets/&#34;</span> <span style=color:#f92672>+</span> label <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.png&#34;</span> <span style=color:#75715e># Get the image path</span>
img <span style=color:#f92672>=</span> Image<span style=color:#f92672>.</span>open(label_flower) <span style=color:#75715e># Open the image</span>
img<span style=color:#f92672>.</span>save(<span style=color:#e6db74>&#34;../../assets/actual_iris.png&#34;</span>) <span style=color:#75715e># Save the image as the actual flower</span>
</code></pre></div><p>With that done, we can now save our predictions to a new feature group that we can use to <strong>monitor</strong> our predictions. This is useful for investigating how our deployed model is performing. To make this more informative, we can add some metadata that will be saved with the predictions. We will add the prediction itself, the ground truth label, and the time of the prediction. We can do this by creating a dictionary and inserting it into the new feature group:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># Get or create the feature group</span>
monitor_fg <span style=color:#f92672>=</span> fs<span style=color:#f92672>.</span>get_or_create_feature_group(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;iris_predictions&#34;</span>,
                                  version<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,
                                  primary_key<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;datetime&#34;</span>], <span style=color:#75715e># Set the primary key</span>
                                  description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Iris flower Prediction/Outcome Monitoring&#34;</span>
                                 )

<span style=color:#75715e># create the metadata</span>
<span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime
now <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%m/</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>/%Y, %H:%M:%S&#34;</span>) <span style=color:#75715e># Get the current time</span>
metadata <span style=color:#f92672>=</span> {
    <span style=color:#e6db74>&#39;prediction&#39;</span>: [flower], <span style=color:#75715e># The prediction</span>
    <span style=color:#e6db74>&#39;label&#39;</span>: [label], <span style=color:#75715e># The ground truth label</span>
    <span style=color:#e6db74>&#39;datetime&#39;</span>: [now], <span style=color:#75715e># The time of the prediction</span>
}
monitor_df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(metadata) <span style=color:#75715e># Create a dataframe from the metadata</span>
monitor_fg<span style=color:#f92672>.</span>insert(monitor_df) <span style=color:#75715e># insert into our monitoring feature group</span>
</code></pre></div><p>We can easily access this feature group by calling <code>.read()</code> on it and can then use this to create some plots to show the user how well the model is performing. A confusion matrix of the predictions for the last five elements of the feature group is performed and a snapshot of the dataframe itself will be saved and shown to the user.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>history_df <span style=color:#f92672>=</span> monitor_fg<span style=color:#f92672>.</span>read() <span style=color:#75715e># Read the monitoring feature group into a dataframe</span>
<span style=color:#f92672>import</span> dataframe_image <span style=color:#f92672>as</span> dfi <span style=color:#75715e># for dataframe snapshot</span>
df_recent <span style=color:#f92672>=</span> history_df<span style=color:#f92672>.</span>tail(<span style=color:#ae81ff>5</span>) <span style=color:#75715e># Get the last 5 predictions</span>
dfi<span style=color:#f92672>.</span>export(df_recent, <span style=color:#e6db74>&#34;../../assets/df_recent.png&#34;</span>) <span style=color:#75715e># Save the dataframe as an image</span>
</code></pre></div><p>In order to create a confusion matrix, we need at least three predictions, one from each class. Therefore, we will run the feature pipeline two more times to get some more synthetic data. Ensure that <code>BACKFILL</code> is set to <code>False</code> in the feature pipeline.</p><p>Now that we have some more data, we can create a confusion matrix and save it to our directory:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> sklearn.metrics <span style=color:#f92672>import</span> confusion_matrix

predictions <span style=color:#f92672>=</span> history_df[[<span style=color:#e6db74>&#39;prediction&#39;</span>]] <span style=color:#75715e># Get the predictions</span>
labels <span style=color:#f92672>=</span> history_df[[<span style=color:#e6db74>&#39;label&#39;</span>]] <span style=color:#75715e># Get the labels</span>
results <span style=color:#f92672>=</span> confusion_matrix(labels, predictions)	<span style=color:#75715e># Create the confusion matrix</span>

<span style=color:#75715e># Only create the confusion matrix when our iris_predictions feature group has examples of all 3 iris flowers</span>
<span style=color:#66d9ef>if</span> results<span style=color:#f92672>.</span>shape <span style=color:#f92672>==</span> (<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>3</span>):
    df_cm <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(results, [<span style=color:#e6db74>&#39;True Setosa&#39;</span>, <span style=color:#e6db74>&#39;True Versicolor&#39;</span>, <span style=color:#e6db74>&#39;True Virginica&#39;</span>],
                         [<span style=color:#e6db74>&#39;Pred Setosa&#39;</span>, <span style=color:#e6db74>&#39;Pred Versicolor&#39;</span>, <span style=color:#e6db74>&#39;Pred Virginica&#39;</span>]) <span style=color:#75715e># Create a dataframe from the confusion matrix</span>
    cm <span style=color:#f92672>=</span> sns<span style=color:#f92672>.</span>heatmap(df_cm, annot<span style=color:#f92672>=</span>True) <span style=color:#75715e># Create a heatmap from the dataframe</span>
    fig <span style=color:#f92672>=</span> cm<span style=color:#f92672>.</span>get_figure() <span style=color:#75715e># Get the figure</span>
    fig<span style=color:#f92672>.</span>savefig(<span style=color:#e6db74>&#34;../../assets/confusion_matrix.png&#34;</span>) <span style=color:#75715e># Save the figure</span>
    df_cm <span style=color:#75715e># Show the dataframe</span>
<span style=color:#66d9ef>else</span>:
    <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#34;Run the batch inference pipeline more times until you get 3 different iris flowers&#34;</span>) <span style=color:#75715e># run feature pipeline more times to get more data</span>
</code></pre></div><p>We now have all the pieces of the puzzle to create our serverless application!!! We just need a way to automate these steps so that it can run on its own. To do this, we will use Github Actions.</p><h2 id=github-actions>GitHub Actions</h2><p>Our pipleline from now on will be as follows:</p><table><thead><tr><th style=text-align:center><img src=images/github_actions_ppln.png alt=actions></th></tr></thead><tbody><tr><td style=text-align:center>Fig 3. Our three pipelines and deployment to GitHub pages.</td></tr></tbody></table><p>Our main dataset, the iris.csv, is used to backfill the &ldquo;iris&rdquo; feature group and is called only once to initially populate our feature store. Synthetic data is produced by our feature pipeline with the <code>get_random_iris_flower()</code> function and will be run once per day. The feature pipeline then inserts the new synthetic data to the &ldquo;iris&rdquo; feature group.</p><p>Next, the training pipeline will take the training data from the feature group by creating a feature view and will train a KNN model on this data. The model will then be evaluated and evaluation metrics, along with the model itself, will be stored in the model registry on Hopsworks.</p><p>Finally, the batch inference pipeline will allow us to make predictions on the latest batch of data from the &ldquo;iris&rdquo; feature group. The predictions will be saved to a new feature group that we can use to monitor our model. We will also save the confusion matrix and a snapshot of the monitoring feature group to our directory so that we can show the user how well the model is performing. Along with this, the current prediction and the actual flower will be saved as images so that we can show the user what the model predicted and what the actual flower was.</p><p>All of these events will be scheduled by Github Actions. and the results will be shown on a github-pages site.</p><p>Before we can use Github Actions, we must save our Hopswork API key in the <em>secrets</em> section of Github. How enigmatic ;) On the topic of enigmas&mldr; We will continue with the automatic deployment of our serverless application on Github Pages in the next post. Stay tuned!</p></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/BenSnow6/BenSnow6.github.io/edit/main/content/posts/ServerlessML/Lab%20Modules/Lab%201/Refactoring/index.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/serverlessml/lab-modules/lab-1/end-to-end-pipeline/ title="End to end pipeline" class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i>Prev</div><div class=next-prev-text>End to end pipeline</div></a></div><div class="col-md-6 next-article"><a href=/posts/serverlessml/lectures/ title=Lectures class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>Lectures</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#feature-pipeline>Feature pipeline</a></li><li><a href=#training-pipeline>Training pipeline</a><ul><li><a href=#feature-view>Feature view</a></li><li><a href=#registering-a-model-on-hopsworks>Registering a model on Hopsworks</a></li></ul></li><li><a href=#inference-pipeline>Inference pipeline</a></li><li><a href=#github-actions>GitHub Actions</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://BenSnow6.github.io#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://BenSnow6.github.io#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://BenSnow6.github.io#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=https://BenSnow6.github.io#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=https://BenSnow6.github.io#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=https://BenSnow6.github.io#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:bensnows@gmail.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span><span>bensnows@gmail.com</span></a></li><li><span><i class="fas fa-phone-alt"></i></span><span>+44 7794748089</span></li></ul></div><div class="col-md-4 col-sm-12"><p>Stay up to date with email notification</p><form method=post action=https://blogtrottr.com><div class=form-group><input type=email class=form-control name=btr_email placeholder="Enter email"><br><input type=hidden name=btr_url value=https://BenSnow6.github.ioindex.xml>
<input type=hidden name=schedule_type value=1>
<small id=emailHelp class="form-text text-muted">By entering your email address, you agree to receive the newsletter of this website.</small>
<button type=submit class="btn btn-info"> Submit</button></div></form></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2022 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script><script type=text/javascript src=/js/popper.min.js></script><script type=text/javascript src=/js/bootstrap.min.js></script><script type=text/javascript src=/js/navbar.js></script><script type=text/javascript src=/js/plyr.js></script><script type=text/javascript src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>