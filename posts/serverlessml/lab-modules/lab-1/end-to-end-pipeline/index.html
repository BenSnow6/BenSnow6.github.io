<!doctype html><html><head><title>End to end pipeline</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600"><link rel=stylesheet href=/fontawesome/css/all.min.css><meta property="og:title" content="End to end pipeline"><meta property="og:description" content="Following along with the serverless-ml online course by Jim Dowling and Hopsworks."><meta property="og:type" content="article"><meta property="og:url" content="https://BenSnow6.github.io/posts/serverlessml/lab-modules/lab-1/end-to-end-pipeline/"><meta property="article:published_time" content="2022-10-05T00:00:00+00:00"><meta property="article:modified_time" content="2022-10-05T00:00:00+00:00"><meta name=description content="Following along with the serverless-ml online course by Jim Dowling and Hopsworks."><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>Ben Snow's Blog</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><a href=/posts/introduction/ title=Introduction>Introduction</a></li><li><a href=/posts/restructuring/ title=Restructuring>Restructuring</a></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/serverlessml/>Serverless ML</a><ul class=active><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/serverlessml/lab-modules/>Lab Modules</a><ul class=active><li><a href=/posts/serverlessml/lab-modules/lab-0/ title="Lab 0">Lab 0</a></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/serverlessml/lab-modules/lab-1/>Lab 1</a><ul class=active><li><a class=active href=/posts/serverlessml/lab-modules/lab-1/end-to-end-pipeline/ title="End to End">End to End</a></li><li><a href=/posts/serverlessml/lab-modules/lab-1/refactoring/ title=Refactoring>Refactoring</a></li></ul></li></ul></li><li><a href=/posts/serverlessml/lectures/ title=Lectures>Lectures</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://BenSnow6.github.io/posts/serverlessml/lab-modules/lab-1/end-to-end-pipeline/hero.png)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/avatar_hub7979d5c0b641038ae587dc7f4e229bf_336111_120x120_fit_q75_box.jpg alt="Author Image"><h5 class=author-name>Ben Snow</h5><p>:date_full</p></div><div class=title><h1>End to end pipeline</h1></div><div class=post-content id=post-content><p>05/10/2022</p><h1 id=lab-1-end-to-end-pipeline>Lab 1 End to end pipeline</h1><p>#machinelearning #course #hopsworks #serverless #gradio</p><p>We&rsquo;re looking at lab 1 of the <a href=https://www.serverless-ml.org/>Serverless-ML course</a> today. Make sure to check out their website and their <a href=https://github.com/featurestoreorg/serverless-ml-course>Github repository and give them a star!</a></p><p><a href=https://github.com/BenSnow6/serverless-ml-course/tree/main/src/01-module>A link to my fork of the repo is here</a> if you wish to follow along with my notebooks!</p><h2 id=introduction>Introduction</h2><p>Following on from Module 0 labs we are now going to look into deploying an actual machine learning product to the web! How exciting! :D</p><p>We are going to investigate the notorious Iris dataset and create several models to predict the variety of flower given a set of characteristics about flowers. This is a simple classification problem and we will use sklearn and pandas to create dataframes, split training and test sets, create a KNN model, evaluate this model, and then query the model! Visualisation with seaborn is used throughout.</p><p>The architecture of the end to end pipeline will look like this:</p><table><thead><tr><th style=text-align:center><img src=images/End2end.png alt=Pipeline></th></tr></thead><tbody><tr><td style=text-align:center>Fig 1. End to end machine learning pipeline for this first section of the lab.</td></tr></tbody></table><p>As you can see, data flows from one end of the pipeline to the other. Data is ingested from a CSV file, processed to create useful features, and then used to train a KNN model. The model is then evaluated and deployed to a web application with Gradio. The web application is then used to query the model and get a prediction.</p><h2 id=downloading-and-visualising-the-data>Downloading and visualising the data</h2><p>We start by reading in the data from a git-repo into a pd dataframe:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>iris_df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>&#34;https://repo.hops.works/master/hopsworks-tutorials/data/iris.csv&#34;</span>)
</code></pre></div><p>It&rsquo;s a good idea to look at data throughout a project, so take some time here to inspect the data we have just downloaded. Creating box plots of the classes vs different attributes is a good way to go. Maybe we can determine some rules ourselves that would help us make a prediction about the classes ourselves. If we can create a few simple rules in our head or spot pattern, it&rsquo;s very likely a machine learning model will be able to do the same!</p><table><thead><tr><th style=text-align:center><img src=images/iris_box_sepal.png alt="Sepal visualisation"></th></tr></thead><tbody><tr><td style=text-align:center>Fig 2. Sepal length vs plant variety. It looks like there already some distinctions between each of the classes&mldr;</td></tr></tbody></table><h2 id=getting-ready-to-fit-a-model>Getting ready to fit a model</h2><p>After looking at some data, let&rsquo;s split it into features and labels:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>features <span style=color:#f92672>=</span> iris_df[[<span style=color:#e6db74>&#34;sepal_length&#34;</span>, <span style=color:#e6db74>&#34;sepal_width&#34;</span>, <span style=color:#e6db74>&#34;petal_length&#34;</span>, <span style=color:#e6db74>&#34;petal_width&#34;</span>]]
labels <span style=color:#f92672>=</span> iris_df[[<span style=color:#e6db74>&#34;variety&#34;</span>]]
</code></pre></div><p>and from here, split into a train and a test set with sklearn:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> sklearn.model_selection <span style=color:#f92672>import</span> train_test_split
X_train,X_test,y_train,y_test <span style=color:#f92672>=</span> train_test_split(features, labels, test_size<span style=color:#f92672>=</span><span style=color:#ae81ff>0.2</span>)
</code></pre></div><p>Sometimes we have to transform our labels to numerical values (string to int or one hot encoding etc&mldr;) but thankfully, KNN models are able to use categorical variables as labels so we don&rsquo;t have to.</p><h2 id=create-a-model-and-fit>Create a model and fit</h2><p>We can now create a KNN classifier with sklearn and fit it to our training dataset:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>model <span style=color:#f92672>=</span> KNeighboursClassifier(n_neighbours<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>) <span style=color:#75715e># 2 nearest neighbour classifier</span>
model<span style=color:#f92672>.</span>fit(X_train, y_train<span style=color:#f92672>.</span>values<span style=color:#f92672>.</span>ravel()) <span style=color:#75715e># fit to training data (ravel allows for categorical labels)</span>
</code></pre></div><h2 id=create-predictions-on-test-data>Create predictions on test data</h2><p>We can now predict the classes of the test set and report back our findings:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>y_pred <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>predict(X_test)
</code></pre></div><p>One way of seeing how well our model predicted the test set is to use sklearn&rsquo;s classification report and confusion matrix:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> sklearn.metrics <span style=color:#f92672>import</span> classification_report
<span style=color:#f92672>from</span> sklearn.metrics <span style=color:#f92672>import</span> confusion_matrix
metrics <span style=color:#f92672>=</span> classification_report(y_test, y_pred, output_dict<span style=color:#f92672>=</span>True)
results <span style=color:#f92672>=</span> confusion_matrix(y_test, y_pred)
</code></pre></div><p>Using matplotlib we can plot a heatmap of the confusion matrix and see how well our model did!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> matplotlib <span style=color:#f92672>import</span> pyplot
<span style=color:#75715e># create dataframe from results</span>
df_cm <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(results, [<span style=color:#e6db74>&#39;True Setosa&#39;</span>, <span style=color:#e6db74>&#39;True Versicolor&#39;</span>, <span style=color:#e6db74>&#39;True Virginica&#39;</span>],
                     [<span style=color:#e6db74>&#39;Pred Setosa&#39;</span>, <span style=color:#e6db74>&#39;Pred Versicolor&#39;</span>, <span style=color:#e6db74>&#39;Pred Virginica&#39;</span>])
<span style=color:#75715e># show confusion matric heat map</span>
sns<span style=color:#f92672>.</span>heatmap(df_cm, annot<span style=color:#f92672>=</span>True)
</code></pre></div><p>the results look like this:</p><table><thead><tr><th style=text-align:center><img src=images/conf_matrix.png alt="Confusion matrix"></th></tr></thead><tbody><tr><td style=text-align:center>Fig 3. Confusion matrix of the KNN model. It looks like the model did a great job of predicting Setosa and Virginica, but struggled a little with Virginica.</td></tr></tbody></table><p>The model correctly classified all of the items in the test set apart from one Virginica flower which it incorrectly predicted to be Versicolor.</p><h2 id=web-app-interface-with-gradio>Web app interface with Gradio</h2><p>It&rsquo;s all well and good having a confusion matrix and some lovely accuracy metrics, but how do we show off this model to a CEO or to a non technical team? Enter Gradio and web apps!</p><p><strong>The idea: Showcase our model&rsquo;s potential by allowing people to interact with it and see its results.</strong></p><p>We will use Gradio to create a lightweight web app that can be hosted online for free for 72 hours (or indefinitely on huggingface spaces!). We will use a few pieces of Gradio&rsquo;s built in UI elements to create an interface and then define a python function that takes in an array of inputs that the user selects and predicts what flower the associated features would yield. It also shows the user a picture of that same flower!</p><p>Here&rsquo;s how it&rsquo;s done:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># import all dependencies</span>
<span style=color:#f92672>import</span> gradio <span style=color:#f92672>as</span> gr
<span style=color:#f92672>import</span> numpy <span style=color:#f92672>as</span> np
<span style=color:#f92672>from</span> PIL <span style=color:#f92672>import</span> Image
<span style=color:#f92672>import</span> requests


<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>iris</span>(sepal_length, sepal_width, petal_length, petal_width):
    <span style=color:#e6db74>&#34;&#34;&#34;Create prediction for iris species based on input features
</span><span style=color:#e6db74>    Args:
</span><span style=color:#e6db74>        sepal_length (float): Length of the sepal
</span><span style=color:#e6db74>        sepal_width (float): Width of the sepal
</span><span style=color:#e6db74>        petal_length (float): Length of the petal
</span><span style=color:#e6db74>        petal_width (float): Width of the petal
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    Returns:
</span><span style=color:#e6db74>        img (PIL.Image): Image of the predicted iris species
</span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
    <span style=color:#75715e># store the inputs in a list</span>
    input_list <span style=color:#f92672>=</span> []
    input_list<span style=color:#f92672>.</span>append(sepal_length)
    input_list<span style=color:#f92672>.</span>append(sepal_width)
    input_list<span style=color:#f92672>.</span>append(petal_length)
    input_list<span style=color:#f92672>.</span>append(petal_width)
    <span style=color:#75715e># make a prediction with the input list (needs to be turned to np array and reshaped to add in an additional set of brackets since predict requires a batch)</span>
    res <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>predict(np<span style=color:#f92672>.</span>asarray(input_list)<span style=color:#f92672>.</span>reshape(<span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>))
    <span style=color:#75715e># fetch the flowe image associated with the prediction (res is an array so grab first element)</span>
    flower_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://raw.githubusercontent.com/featurestoreorg/serverless-ml-course/main/src/01-module/assets/&#34;</span> <span style=color:#f92672>+</span> res[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.png&#34;</span>
    <span style=color:#75715e># open image</span>
    img <span style=color:#f92672>=</span> Image<span style=color:#f92672>.</span>open(requests<span style=color:#f92672>.</span>get(flower_url, stream<span style=color:#f92672>=</span>True)<span style=color:#f92672>.</span>raw)            
    <span style=color:#75715e># return image</span>
    <span style=color:#66d9ef>return</span> img

<span style=color:#75715e># create a gradio interface and assign the iris function</span>
demo <span style=color:#f92672>=</span> gr<span style=color:#f92672>.</span>Interface(
    fn<span style=color:#f92672>=</span>iris, <span style=color:#75715e># The function to be wrapped </span>
    title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Iris Flower Predictive Analytics&#34;</span>, <span style=color:#75715e># Interface title</span>
    description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Experiment with sepal/petal lengths/widths to predict which flower it is.&#34;</span>, <span style=color:#75715e># interface description</span>
    allow_flagging<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;never&#34;</span>,
    inputs<span style=color:#f92672>=</span>[
        gr<span style=color:#f92672>.</span>inputs<span style=color:#f92672>.</span>Number(default<span style=color:#f92672>=</span><span style=color:#ae81ff>1.0</span>, label<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sepal length (cm)&#34;</span>), <span style=color:#75715e># use box input</span>
        gr<span style=color:#f92672>.</span>inputs<span style=color:#f92672>.</span>Number(default<span style=color:#f92672>=</span><span style=color:#ae81ff>1.0</span>, label<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sepal width (cm)&#34;</span>),
        gr<span style=color:#f92672>.</span>inputs<span style=color:#f92672>.</span>Number(default<span style=color:#f92672>=</span><span style=color:#ae81ff>1.0</span>, label<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;petal length (cm)&#34;</span>),
		gr<span style=color:#f92672>.</span>Slider(minimum<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, maximum<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, label<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;petal width (cm)&#34;</span>), <span style=color:#75715e># slider cuz we&#39;re cool</span>
        ],
    outputs<span style=color:#f92672>=</span>gr<span style=color:#f92672>.</span>Image(type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;pil&#34;</span>)) <span style=color:#75715e># show the image as the output</span>
<span style=color:#75715e># launch the model to the web!</span>
demo<span style=color:#f92672>.</span>launch(share<span style=color:#f92672>=</span>True)
</code></pre></div><table><thead><tr><th style=text-align:center><img src=images/gradio_app.png alt="Gradio app"></th></tr></thead><tbody><tr><td style=text-align:center>Fig 4. Gradio app interface. The user can interact with the input boxes and sliders and see the predicted flower image change.</td></tr></tbody></table><p>How jazzy is that? That&rsquo;s far better than the confusion matrix we used saw earlier isn&rsquo;t it? It&rsquo;s interactive, anyone can use it and play around, and it shows off how quick and powerful the model is!!</p><p>I love it!</p><p>You can have a go of the web app here until the 8th of October 2022 <a href=https://23930.gradio.app>here</a>.</p><h3 id=bonus>Bonus</h3><p>As a bonus, I came across this lovely picture of hot air balloons when I was looking up some formatting tips for markdown. I thought I&rsquo;d share it with you all!</p><table><thead><tr><th style=text-align:center><img src=https://blog-assets.thedyrt.com/uploads/2019/01/shutterstock_1033306540-1.jpg alt=space-1.jpg></th></tr></thead><tbody><tr><td style=text-align:center>Fig 5: Image Credits - shutterstock.com</td></tr></tbody></table></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/BenSnow6/BenSnow6.github.io/edit/main/content/posts/ServerlessML/Lab%20Modules/Lab%201/End%20to%20end%20pipeline/index.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/serverlessml/lab-modules/lab-0/ title="Serverless Machine Learning Module 0" class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i>Prev</div><div class=next-prev-text>Serverless Machine Learning Module 0</div></a></div><div class="col-md-6 next-article"><a href=/posts/serverlessml/lab-modules/lab-1/refactoring/ title="Refactoring the pipeline" class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>Refactoring the pipeline</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#downloading-and-visualising-the-data>Downloading and visualising the data</a></li><li><a href=#getting-ready-to-fit-a-model>Getting ready to fit a model</a></li><li><a href=#create-a-model-and-fit>Create a model and fit</a></li><li><a href=#create-predictions-on-test-data>Create predictions on test data</a></li><li><a href=#web-app-interface-with-gradio>Web app interface with Gradio</a><ul><li><a href=#bonus>Bonus</a></li></ul></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://BenSnow6.github.io#about>About</a></li><li class=nav-item><a class=smooth-scroll href=https://BenSnow6.github.io#skills>Skills</a></li><li class=nav-item><a class=smooth-scroll href=https://BenSnow6.github.io#education>Education</a></li><li class=nav-item><a class=smooth-scroll href=https://BenSnow6.github.io#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=https://BenSnow6.github.io#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=https://BenSnow6.github.io#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:bensnows@gmail.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span><span>bensnows@gmail.com</span></a></li><li><span><i class="fas fa-phone-alt"></i></span><span>+44 7794748089</span></li></ul></div><div class="col-md-4 col-sm-12"><p>Stay up to date with email notification</p><form method=post action=https://blogtrottr.com><div class=form-group><input type=email class=form-control name=btr_email placeholder="Enter email"><br><input type=hidden name=btr_url value=https://BenSnow6.github.ioindex.xml>
<input type=hidden name=schedule_type value=1>
<small id=emailHelp class="form-text text-muted">By entering your email address, you agree to receive the newsletter of this website.</small>
<button type=submit class="btn btn-info"> Submit</button></div></form></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2022 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script><script type=text/javascript src=/js/popper.min.js></script><script type=text/javascript src=/js/bootstrap.min.js></script><script type=text/javascript src=/js/navbar.js></script><script type=text/javascript src=/js/plyr.js></script><script type=text/javascript src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>